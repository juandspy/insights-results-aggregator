<!DOCTYPE html>
<!--
 Copyright 2023 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>actual_migrations_test.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>actual_migrations_test.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"><p>Copyright 2020, 2021, 2022 Red Hat, Inc</p>

<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code> http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</td>
	<td class="code"><pre><code><div class="keyword">package</div> <div class="ident">migration_test</div><div class="operator"></div>

<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>
	<div class="literal">&#34;database/sql/driver&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;testing&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/DATA-DOG/go-sqlmock&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/tests/helpers&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator-data/testdata&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/stretchr/testify/assert&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/migration&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/storage&#34;</div><div class="operator"></div>
	<div class="ident">ira_helpers</div> <div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/tests/helpers&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/types&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">GetTxForMigration</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">Sqlmock</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectBegin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Begin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">tx</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestAllMigrations</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationsOneByOne</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">allMigrations</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migration</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">copy</div><div class="operator">(</div><div class="ident">allMigrations</div><div class="operator">,</div> <div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migration</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">i</div> <div class="operator">:=</div> <div class="literal">0</div><div class="operator">;</div> <div class="ident">i</div> <div class="operator">&lt;</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">allMigrations</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">i</div><div class="operator">&#43;&#43;</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>add one migration to the list</p>
</td>
	<td class="code"><pre><code>		<div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div><div class="operator">,</div> <div class="ident">allMigrations</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration1_TableReportAlreadyExists</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`CREATE TABLE report(c INTEGER);`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;table report already exists&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration1_TableReportDoesNotExist</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>set to the version with the report table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`DROP TABLE report;`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to set to the first version</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: report&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration2_TableRuleAlreadyExists</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`CREATE TABLE rule(c INTEGER);`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;table rule already exists&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration2_TableRuleDoesNotExist</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>set to the version where table rule exists</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">2</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
		<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`DROP TABLE rule;`</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`DROP TABLE rule CASCADE;`</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to set to the first version</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: rule&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration2_TableRuleErrorKeyAlreadyExists</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`CREATE TABLE rule_error_key(c INTEGER);`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;table rule_error_key already exists&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration2_TableRuleErrorKeyDoesNotExist</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>set to the latest version</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">2</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`DROP TABLE rule_error_key;`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to set to the first version</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: rule_error_key&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration3_TableClusterRuleUserFeedbackAlreadyExists</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`CREATE TABLE cluster_rule_user_feedback(c INTEGER);`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;table cluster_rule_user_feedback already exists&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration3_TableClusterRuleUserFeedbackDoesNotExist</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>set to the latest version</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">3</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`DROP TABLE cluster_rule_user_feedback;`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to set to the first version</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: cluster_rule_user_feedback&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration4_StepUp_TableClusterRuleUserFeedbackDoesNotExist</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">3</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`DROP TABLE cluster_rule_user_feedback;`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: cluster_rule_user_feedback&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration4_StepDown_TableClusterRuleUserFeedbackDoesNotExist</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">4</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`DROP TABLE cluster_rule_user_feedback;`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: cluster_rule_user_feedback&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration4_CreateTableError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">expectedErr</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;create table error&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mig4</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Mig0004ModifyClusterRuleUserFeedback</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">method</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">func</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div><div class="operator">{</div><div class="ident">mig4</div><div class="operator">.</div><div class="ident">StepUp</div><div class="operator">,</div> <div class="ident">mig4</div><div class="operator">.</div><div class="ident">StepDown</div><div class="operator">}</div> <div class="operator">{</div>
		<div class="keyword">func</div><div class="operator">(</div><div class="ident">method</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
			<div class="ident">tx</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">GetTxForMigration</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;ALTER TABLE&#34;</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE&#34;</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">expectedErr</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">method</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverGeneral</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">expectedErr</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator">(</div><div class="ident">method</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration4_InsertError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">expectedErr</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;insert error&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mig4</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Mig0004ModifyClusterRuleUserFeedback</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">method</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">func</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div><div class="operator">{</div><div class="ident">mig4</div><div class="operator">.</div><div class="ident">StepUp</div><div class="operator">,</div> <div class="ident">mig4</div><div class="operator">.</div><div class="ident">StepDown</div><div class="operator">}</div> <div class="operator">{</div>
		<div class="keyword">func</div><div class="operator">(</div><div class="ident">method</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
			<div class="ident">tx</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">GetTxForMigration</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;ALTER TABLE&#34;</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE&#34;</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO&#34;</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">expectedErr</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">method</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverGeneral</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">expectedErr</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator">(</div><div class="ident">method</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration4_DropTableError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">expectedErr</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;drop table error&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">mig4</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Mig0004ModifyClusterRuleUserFeedback</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">method</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">func</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div><div class="operator">{</div><div class="ident">mig4</div><div class="operator">.</div><div class="ident">StepUp</div><div class="operator">,</div> <div class="ident">mig4</div><div class="operator">.</div><div class="ident">StepDown</div><div class="operator">}</div> <div class="operator">{</div>
		<div class="keyword">func</div><div class="operator">(</div><div class="ident">method</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
			<div class="ident">tx</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">GetTxForMigration</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;ALTER TABLE&#34;</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE&#34;</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO&#34;</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;DROP TABLE&#34;</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">expectedErr</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">method</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverGeneral</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">expectedErr</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator">(</div><div class="ident">method</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration5_TableAlreadyExists</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE consumer_error(c INTEGER);&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;table consumer_error already exists&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration5_NoSuchTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">5</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`DROP TABLE consumer_error`</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: consumer_error&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration13</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>migration is not implemented for sqlite</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">12</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO report (org_id, cluster, report, reported_at, last_checked_at)
		VALUES ($1, $2, $3, $4, $5)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReport3Rules</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">13</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assertRule</div> <div class="operator">:=</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">ruleFQDN</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div> <div class="ident">expectedTemplateData</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">templateData</div> <div class="ident">string</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
			SELECT
				template_data
			FROM
				rule_hit
			WHERE
				org_id = $1 AND cluster_id = $2 AND
				rule_fqdn = $3 AND error_key = $4
		`</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
			<div class="ident">ruleFQDN</div><div class="operator">,</div>
			<div class="ident">errorKey</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
			<div class="operator">&amp;</div><div class="ident">templateData</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">helpers</div><div class="operator">.</div><div class="ident">IsStringJSON</div><div class="operator">(</div><div class="ident">expectedTemplateData</div><div class="operator">)</div> <div class="operator">{</div>
			<div class="ident">assert</div><div class="operator">.</div><div class="ident">JSONEq</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expectedTemplateData</div><div class="operator">,</div> <div class="ident">templateData</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expectedTemplateData</div><div class="operator">,</div> <div class="ident">templateData</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">assertRule</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div> <div class="ident">helpers</div><div class="operator">.</div><div class="ident">ToJSONString</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ExtraData</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assertRule</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule2ID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey2</div><div class="operator">,</div> <div class="ident">helpers</div><div class="operator">.</div><div class="ident">ToJSONString</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule2ExtraData</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assertRule</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule3ID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey3</div><div class="operator">,</div> <div class="ident">helpers</div><div class="operator">.</div><div class="ident">ToJSONString</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule3ExtraData</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration16</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">15</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO recommendation (org_id, cluster_id, rule_fqdn, error_key)
		VALUES ($1, $2, $3, $4)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1Name</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">`Expected error since recommendation table does not exist yet`</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
		<div class="ident">assert</div><div class="operator">.</div><div class="ident">Contains</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;no such table: recommendation&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverPostgres</div> <div class="operator">{</div>
		<div class="ident">assert</div><div class="operator">.</div><div class="ident">Contains</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">`relation &#34;recommendation&#34; does not exist`</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">16</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO recommendation (org_id, cluster_id, rule_fqdn, error_key)
		VALUES ($1, $2, $3, $4)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1Name</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration19</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>

	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>nothing worth testing for sqlite</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">18</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`SELECT created_at FROM recommendation`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;created_at column should not exist&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`SELECT rule_id FROM recommendation`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;rule_id column should not exist&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">correctRuleID</div> <div class="operator">:=</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div> <div class="operator">&#43;</div> <div class="literal">&#34;|&#34;</div> <div class="operator">&#43;</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator"></div>
	<div class="ident">incorrectRuleFQDN</div> <div class="operator">:=</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div> <div class="operator">&#43;</div> <div class="literal">&#34;.&#34;</div> <div class="operator">&#43;</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator"></div>

	<div class="ident">expectedRuleAfterMigration</div> <div class="operator">:=</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO recommendation (org_id, cluster_id, rule_fqdn, error_key)
		VALUES ($1, $2, $3, $4)
		`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">incorrectRuleFQDN</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO recommendation (org_id, cluster_id, rule_fqdn, error_key)
		VALUES ($1, $2, $3, $4)
		`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Org2ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">correctRuleID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">19</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="operator">(</div>
		<div class="ident">ruleFQDN</div> <div class="ident">string</div><div class="operator"></div>
		<div class="ident">ruleID</div>   <div class="ident">string</div><div class="operator"></div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
			SELECT
				rule_fqdn, rule_id
			FROM
				recommendation
			WHERE
				org_id = $1`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">ruleFQDN</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ruleID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expectedRuleAfterMigration</div><div class="operator">,</div> <div class="ident">ruleFQDN</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">correctRuleID</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
			SELECT
				rule_fqdn, rule_id
			FROM
				recommendation
			WHERE
				org_id = $1`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Org2ID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">ruleFQDN</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ruleID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expectedRuleAfterMigration</div><div class="operator">,</div> <div class="ident">ruleFQDN</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">correctRuleID</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">timestamp</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
			SELECT
				created_at
			FROM
				recommendation
			WHERE
				org_id = $1`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">timestamp</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">False</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">timestamp</div><div class="operator">.</div><div class="ident">IsZero</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;The timestamp column was not created with a default value&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">True</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">timestamp</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">timestamp</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;The stored timestamp is not in UTC format&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step down should remove created<em>at and rule</em>id columns</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">18</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`SELECT created_at FROM recommendation`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;created_at column should not exist&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`SELECT rule_id FROM recommendation`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;rule_id column should not exist&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration18</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">17</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO advisor_ratings
		(user_id, org_id, rule_id, error_key, rated_at, last_updated_at, rating)
		VALUES
		($1, $2, $3, $4, $5, $6, $7)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1Name</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">UserVoteLike</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">`Expected error since advisor_ratings table does not exist yet`</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
		<div class="ident">assert</div><div class="operator">.</div><div class="ident">Contains</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;no such table: advisor_ratings&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverPostgres</div> <div class="operator">{</div>
		<div class="ident">assert</div><div class="operator">.</div><div class="ident">Contains</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">`relation &#34;advisor_ratings&#34; does not exist`</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">18</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO advisor_ratings
		(user_id, org_id, rule_id, error_key, rated_at, last_updated_at, rating)
		VALUES
		($1, $2, $3, $4, $5, $6, $7)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1Name</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">UserVoteLike</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration20</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>nothing worth testing for sqlite</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">19</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`SELECT rule_fqdn FROM advisor_ratings`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;rule_fqdn column should not exist&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO advisor_ratings
		(user_id, org_id, rule_id, error_key, rated_at, last_updated_at, rating)
		VALUES
		($1, $2, $3, $4, $5, $6, $7)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">UserVoteLike</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">20</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="operator">(</div>
		<div class="ident">ruleFQDN</div> <div class="ident">string</div><div class="operator"></div>
		<div class="ident">ruleID</div>   <div class="ident">string</div><div class="operator"></div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
			SELECT
				rule_fqdn, rule_id
			FROM
				advisor_ratings
			WHERE
				user_id = $1 AND org_id = $2`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">ruleFQDN</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ruleID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">(</div><div class="ident">ruleFQDN</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1CompositeID</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step down should rename rule<em>fqdn column to rule</em>id and it contains only plugin name</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">19</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`SELECT rule_fqdn FROM advisor_ratings`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;rule_fqdn column should not exist&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
			SELECT
				rule_id
			FROM
				advisor_ratings
			WHERE
				user_id = $1 AND org_id = $2`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">ruleID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration22</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>sqlite is no longer supported</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">21</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">expectedCorrectCount</div> <div class="ident">int</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert toggles and feedbacks</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">i</div> <div class="operator">:=</div> <div class="literal">0</div><div class="operator">;</div> <div class="ident">i</div> <div class="operator">&lt;</div> <div class="literal">10</div><div class="operator">;</div> <div class="ident">i</div><div class="operator">&#43;&#43;</div> <div class="operator">{</div>
		<div class="ident">ruleID</div> <div class="operator">:=</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator"></div>
		<div class="ident">clusterID</div> <div class="operator">:=</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">GetRandomClusterID</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we expect 4 with the suffix (correct) and 6 without the suffix (to be deleted)</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">i</div><div class="operator">%</div><div class="literal">2</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
			<div class="ident">ruleID</div> <div class="operator">&#43;=</div> <div class="literal">&#34;.report&#34;</div><div class="operator"></div>
			<div class="ident">expectedCorrectCount</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert toggles</p>
</td>
	<td class="code"><pre><code>		<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
				INSERT INTO cluster_rule_toggle
				(cluster_id, rule_id, error_key, user_id, disabled, updated_at)
				VALUES
				($1, $2, $3, $4, $5, $6)
			`</div><div class="operator">,</div>
			<div class="ident">clusterID</div><div class="operator">,</div>
			<div class="ident">ruleID</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div> <div class="comment">// we don&#39;t care about error key or any other column</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
			<div class="ident">storage</div><div class="operator">.</div><div class="ident">RuleToggleDisable</div><div class="operator">,</div>
			<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert disable feedbacks</p>
</td>
	<td class="code"><pre><code>		<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
				INSERT INTO cluster_user_rule_disable_feedback
				(cluster_id, rule_id, error_key, user_id, message, added_at, updated_at)
				VALUES
				($1, $2, $3, $4, $5, $6, $6)
			`</div><div class="operator">,</div>
			<div class="ident">clusterID</div><div class="operator">,</div>
			<div class="ident">ruleID</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div> <div class="comment">// we don&#39;t care about error key or any other column</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
			<div class="literal">&#34;&#34;</div><div class="operator">,</div>
			<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>migrate to 22</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">22</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve numbers of rows</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">var</div> <div class="ident">togglesAfterMigrationCount</div><div class="operator">,</div> <div class="ident">feedbacksAfterMigrationCount</div> <div class="ident">int</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
	SELECT
		count(*)
	FROM
		cluster_rule_toggle
	`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">togglesAfterMigrationCount</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>must match with expected count</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expectedCorrectCount</div><div class="operator">,</div> <div class="ident">togglesAfterMigrationCount</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
	SELECT
		count(*)
	FROM
		cluster_user_rule_disable_feedback
	`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">feedbacksAfterMigrationCount</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>must match with expected count</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expectedCorrectCount</div><div class="operator">,</div> <div class="ident">feedbacksAfterMigrationCount</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>there is no need to test StepDown because it's a NOOP</p>
</td>
	<td class="code"><pre><code><div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration24</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>sqlite is no longer supported</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">23</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`SELECT created_at FROM rule_hit`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NotNil</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>migrate to 24</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">24</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`SELECT created_at FROM rule_hit`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration25</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>sqlite is no longer supported</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">24</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`SELECT impacted_since FROM recommendation`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>migrate to 25</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">25</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`SELECT impacted_since FROM recommendation`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration26</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>sqlite is no longer supported</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">25</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`SELECT org_id FROM cluster_rule_toggle`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`SELECT org_id FROM cluster_rule_user_feedback`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`SELECT org_id FROM cluster_user_rule_disable_feedback`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into report table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO report (org_id, cluster, report, reported_at, last_checked_at)
		VALUES ($1, $2, $3, $4, $5)
		`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReport3Rules</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into cluster<em>rule</em>toggle</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`INSERT INTO cluster_rule_toggle (cluster_id, rule_id, error_key, user_id, disabled, updated_at)
		VALUES ($1, $2, $3, $4, $5, $6)`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="literal">1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">unknownClusterID</div> <div class="operator">:=</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">GetRandomClusterID</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into cluster<em>rule</em>toggle</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`INSERT INTO cluster_rule_toggle (cluster_id, rule_id, error_key, user_id, disabled, updated_at)
		VALUES ($1, $2, $3, $4, $5, $6)`</div><div class="operator">,</div>
		<div class="ident">unknownClusterID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="literal">1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>migrate to 26, popoulating org_id column based on report table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">26</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
	SELECT
		org_id
	FROM
		cluster_rule_toggle
	WHERE
		cluster_id = $1
	`</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">orgID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>org_id must match that in report table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
	SELECT
		org_id
	FROM
		cluster_rule_toggle
	WHERE
		cluster_id = $1
	`</div><div class="operator">,</div> <div class="ident">unknownClusterID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">orgID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>cluster wasn't found in report table, org_id will be default value 0</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration27</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">countQuery</div> <div class="operator">=</div> <div class="literal">&#34;SELECT count(*) FROM %v&#34;</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>contains 2 valid and 1 invalid orgID</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">var</div> <div class="ident">orgIDList</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;0&#34;</div><div class="operator">,</div> <div class="literal">&#34;1&#34;</div><div class="operator">,</div> <div class="literal">&#34;2&#34;</div><div class="operator">}</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">tableList</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
		<div class="literal">&#34;cluster_rule_toggle&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;cluster_rule_user_feedback&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;cluster_user_rule_disable_feedback&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>sqlite is no longer supported</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">26</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into report table because of DB constraints</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO report (org_id, cluster, report, reported_at, last_checked_at)
		VALUES ($1, $2, $3, $4, $5)
		`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReport3Rules</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert 3 rows into table, one of them invalid</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">i</div><div class="operator">,</div> <div class="ident">orgID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">orgIDList</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into cluster<em>rule</em>toggle</p>
</td>
	<td class="code"><pre><code>		<div class="ident">userID</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;%v&#34;</div><div class="operator">,</div> <div class="ident">i</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
			<div class="literal">`INSERT INTO cluster_rule_toggle (cluster_id, rule_id, error_key, user_id, disabled, updated_at, org_id)
			VALUES ($1, $2, $3, $4, $5, $6, $7)`</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
			<div class="ident">userID</div><div class="operator">,</div> <div class="comment">// random stuff because of DB constraints</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
			<div class="literal">1</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
			<div class="ident">orgID</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into cluster<em>user</em>rule<em>disable</em>feedback</p>
</td>
	<td class="code"><pre><code>		<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
			<div class="literal">`INSERT INTO cluster_user_rule_disable_feedback
				(cluster_id, rule_id, error_key, user_id, message, added_at, updated_at, org_id)
			VALUES
				($1, $2, $3, $4, $5, $6, $7, $8)`</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
			<div class="ident">userID</div><div class="operator">,</div>
			<div class="literal">&#34;reason&#34;</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
			<div class="ident">orgID</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into cluster<em>rule</em>user_feedback</p>
</td>
	<td class="code"><pre><code>		<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
			<div class="literal">`INSERT INTO cluster_rule_user_feedback
				(cluster_id, rule_id, error_key, user_id, message, added_at, updated_at, user_vote, org_id)
			VALUES
				($1, $2, $3, $4, $5, $6, $7, $8, $9)`</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
			<div class="ident">userID</div><div class="operator">,</div>
			<div class="literal">&#34;reason&#34;</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
			<div class="literal">1</div><div class="operator">,</div>
			<div class="ident">orgID</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check correct number of rows inserted (3)</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">table</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">tableList</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">cnt</div> <div class="ident">int</div><div class="operator"></div>
		<div class="ident">query</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="ident">countQuery</div><div class="operator">,</div> <div class="ident">table</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="ident">query</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cnt</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expect 3 rows</p>
</td>
	<td class="code"><pre><code>		<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">cnt</div><div class="operator">,</div> <div class="literal">3</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>migrate to 27, deleting rows where org_id = 0</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">27</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check correct number of rows remaining (2)</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">table</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">tableList</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">cnt</div> <div class="ident">int</div><div class="operator"></div>
		<div class="ident">query</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="ident">countQuery</div><div class="operator">,</div> <div class="ident">table</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="ident">query</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cnt</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>expect 2 rows, one was supposed to be deleted in all tables</p>
</td>
	<td class="code"><pre><code>		<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">cnt</div><div class="operator">,</div> <div class="literal">2</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration28</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>sqlite is no longer supported</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">27</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into rule_disable</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`INSERT INTO rule_disable
				(org_id, user_id, rule_id, error_key, created_at)
			VALUES
				($1, $2, $3, $4, $5)`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into rule<em>disable different user</em>id, same org_id</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`INSERT INTO rule_disable
				(org_id, user_id, rule_id, error_key, created_at)
			VALUES
				($1, $2, $3, $4, $5)`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">User2ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>possible to insert more than 1 row per org</p>
</td>
	<td class="code"><pre><code>	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>delete from table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`DELETE FROM rule_disable`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>migrate to different constraint</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">28</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into rule_disable</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`INSERT INTO rule_disable
				(org_id, user_id, rule_id, error_key, created_at)
			VALUES
				($1, $2, $3, $4, $5)`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert into rule<em>disable different user</em>id, same org_id</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="literal">`INSERT INTO rule_disable
				(org_id, user_id, rule_id, error_key, created_at)
			VALUES
				($1, $2, $3, $4, $5)`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">User2ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>not possible to insert more than 1 row per org</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration29</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>nothing worth testing for sqlite</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">28</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO cluster_rule_toggle
		(cluster_id, user_id, org_id, rule_id, error_key, disabled, disabled_at, updated_at)
		VALUES
		($1, $2, $3, $4, $5, $6, $7, $8)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="literal">1</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">29</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`SELECT user_id FROM cluster_rule_toggle`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;user_id column should not exist&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">28</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
	SELECT
		user_id
	FROM
		cluster_rule_toggle
	`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>default value on stepdown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">(</div><div class="literal">&#34;-1&#34;</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration30</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>nothing worth testing for sqlite</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">29</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO rule_disable
		(user_id, org_id, rule_id, error_key, justification, created_at, updated_at)
		VALUES
		($1, $2, $3, $4, $5, $6, $7)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="literal">&#34;&#34;</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">30</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`SELECT user_id FROM rule_disable`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;user_id column should not exist&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">29</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
	SELECT
		user_id
	FROM
		rule_disable
	`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>default value on stepdown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">(</div><div class="literal">&#34;-1&#34;</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigration31</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">dbDriver</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>nothing worth testing for sqlite</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">30</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO advisor_ratings
		(user_id, org_id, rule_fqdn, error_key, rated_at, last_updated_at, rating, rule_id)
		VALUES
		($1, $2, $3, $4, $5, $6, $7, $8)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="literal">1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1CompositeID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">31</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO advisor_ratings
		(org_id, rule_fqdn, error_key, rated_at, last_updated_at, rating, rule_id)
		VALUES
		($1, $2, $3, $4, $5, $6, $7)
	`</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1ID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ErrorKey1</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="literal">1</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Rule1CompositeID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`SELECT user_id FROM advisor_ratings`</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;user_id column should not exist&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">30</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
	SELECT
		user_id
	FROM
		advisor_ratings
	`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
		<div class="operator">&amp;</div><div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>default value on stepdown</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">(</div><div class="literal">&#34;-1&#34;</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
