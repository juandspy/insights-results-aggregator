<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Architecture | Insights Results Aggregator</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Architecture" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Aggregator service for Openshist insights results" />
<meta property="og:description" content="Aggregator service for Openshist insights results" />
<link rel="canonical" href="https://redhatinsights.github.io/insights-results-aggregator/architecture.html" />
<meta property="og:url" content="https://redhatinsights.github.io/insights-results-aggregator/architecture.html" />
<meta property="og:site_name" content="Insights Results Aggregator" />
<script type="application/ld+json">
{"description":"Aggregator service for Openshist insights results","url":"https://redhatinsights.github.io/insights-results-aggregator/architecture.html","headline":"Architecture","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/insights-results-aggregator/assets/css/style.css?v=">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="https://redhatinsights.github.io/insights-results-aggregator/">Insights Results Aggregator</a></h1>
      

      <h1 id="architecture">Architecture</h1>

<p>Aggregator service consists of three main parts:</p>

<ol>
  <li>Consumer that reads (consumes) Insights OCP messages from specified message broker. Usually Kafka
broker is used but it might be possible to develop a interface for different broker. Insights</li>
  <li>OCP messages are basically encoded in JSON and contain results generated by rule engine.</li>
  <li>HTTP or HTTPS server that exposes REST API endpoints that can be used to read list of
organizations, list of clusters, read rules results for selected cluster etc. Additionally,
basic metrics are exposed as well. Those metrics is configured to be consumed by Prometheus and
visualized by Grafana.</li>
  <li>Storage backend which is some instance of SQL database. Currently SQLite3 and PostgreSQL are
fully supported, but more SQL databases might be added later.</li>
</ol>

<h2 id="whole-data-flow">Whole data flow</h2>

<p><img src="/insights-results-aggregator/assets/customer-facing-services-architecture.png" alt="data_flow" /></p>

<ol>
  <li>Event about new data from insights operator is consumed from Kafka. That event contains (among
other things) URL to S3 Bucket</li>
  <li>Insights operator data is read from S3 Bucket and Insights rules are applied to that data</li>
  <li>Results (basically organization ID + cluster name + insights results JSON) are stored back into
Kafka, but into different topic</li>
  <li>That results are consumed by Insights rules aggregator service that caches them</li>
  <li>The service provides such data via REST API to other tools, like OpenShift Cluster Manager web
UI, OpenShift console, etc.</li>
</ol>

<p>Optionally, an organization allowlist can be enabled by the configuration variable
<code class="language-plaintext highlighter-rouge">enable_org_allowlist</code>, which enables processing of a .csv file containing organization IDs (path
specified by the config variable <code class="language-plaintext highlighter-rouge">org_allowlist</code>) and allows report processing only for these
organizations. This feature is disabled by default, and might be removed altogether in the near
future.</p>

<hr />
<p><strong>NOTE</strong></p>

<p>Detailed information about the exact format of consumed data from Kafka topic is
available at</p>

<p>https://redhatinsights.github.io/insights-data-schemas/ccx_ocp_results_topic.html</p>

<hr />


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/RedHatInsights/insights-results-aggregator/edit/gh-pages/architecture.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
