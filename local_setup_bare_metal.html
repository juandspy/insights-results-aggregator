<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Local setup on bare metal | Insights Results Aggregator</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Local setup on bare metal" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Aggregator service for Openshist insights results" />
<meta property="og:description" content="Aggregator service for Openshist insights results" />
<link rel="canonical" href="https://redhatinsights.github.io/insights-results-aggregator/local_setup_bare_metal.html" />
<meta property="og:url" content="https://redhatinsights.github.io/insights-results-aggregator/local_setup_bare_metal.html" />
<meta property="og:site_name" content="Insights Results Aggregator" />
<script type="application/ld+json">
{"description":"Aggregator service for Openshist insights results","url":"https://redhatinsights.github.io/insights-results-aggregator/local_setup_bare_metal.html","headline":"Local setup on bare metal","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/insights-results-aggregator/assets/css/style.css?v=">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="https://redhatinsights.github.io/insights-results-aggregator/">Insights Results Aggregator</a></h1>
      

      <h1 class="no_toc" id="local-setup-on-bare-metal">Local setup on bare metal</h1>

<h2 class="no_toc text-delta" id="table-of-contents">Table of contents</h2>

<ol id="markdown-toc">
  <li><a href="#synopsis" id="markdown-toc-synopsis">Synopsis</a></li>
  <li><a href="#basic-setup" id="markdown-toc-basic-setup">Basic setup</a>    <ol>
      <li><a href="#system-info" id="markdown-toc-system-info">System info</a></li>
      <li><a href="#common-packages-to-be-used" id="markdown-toc-common-packages-to-be-used">Common packages to be used</a></li>
    </ol>
  </li>
  <li><a href="#postgresql-installation-and-setup" id="markdown-toc-postgresql-installation-and-setup">PostgreSQL installation and setup</a>    <ol>
      <li><a href="#package-installation" id="markdown-toc-package-installation">Package installation</a></li>
      <li><a href="#database-setup" id="markdown-toc-database-setup">Database setup</a></li>
      <li><a href="#start-db-service" id="markdown-toc-start-db-service">Start DB service</a></li>
      <li><a href="#create-postgresql-account" id="markdown-toc-create-postgresql-account">Create PostgreSQL account</a></li>
      <li><a href="#alternative-setup-on-recent-fedoras" id="markdown-toc-alternative-setup-on-recent-fedoras">Alternative setup on recent Fedoras</a></li>
    </ol>
  </li>
  <li><a href="#kafka-installation-and-setup" id="markdown-toc-kafka-installation-and-setup">Kafka installation and setup</a>    <ol>
      <li><a href="#package-installation-1" id="markdown-toc-package-installation-1">Package installation</a></li>
      <li><a href="#start-zookeeper-and-kafka" id="markdown-toc-start-zookeeper-and-kafka">Start Zookeeper and Kafka</a></li>
    </ol>
  </li>
  <li><a href="#kafkacat-installation-and-setup" id="markdown-toc-kafkacat-installation-and-setup">Kafkacat installation and setup</a>    <ol>
      <li><a href="#installation" id="markdown-toc-installation">Installation</a></li>
      <li><a href="#build" id="markdown-toc-build">Build</a></li>
      <li><a href="#check-connection-to-kafka" id="markdown-toc-check-connection-to-kafka">Check connection to Kafka</a></li>
    </ol>
  </li>
  <li><a href="#insights-results-aggregator-installation-and-setup" id="markdown-toc-insights-results-aggregator-installation-and-setup">Insights Results Aggregator installation and setup</a>    <ol>
      <li><a href="#dependend-packages-installation" id="markdown-toc-dependend-packages-installation">Dependend packages installation</a></li>
      <li><a href="#insights-results-aggregator-setup" id="markdown-toc-insights-results-aggregator-setup">Insights Results Aggregator setup</a></li>
      <li><a href="#aggregator-database-setup" id="markdown-toc-aggregator-database-setup">Aggregator database setup</a></li>
      <li><a href="#run-db-writer" id="markdown-toc-run-db-writer">Run DB writer</a></li>
    </ol>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

<h2 id="synopsis">Synopsis</h2>

<p>Sometimes it is needed to be able to run Insights Results Aggregator, DB
Writer, PostgreSQL database, and Kafka instance on bare metal. Just on bare
metal it would be possible to run benchmarks or performance tests and get
reliable results. This document contains description how to setup all such
tools and services on brand new Fedora 35 Server system.</p>

<h2 id="basic-setup">Basic setup</h2>

<p>Some preparation steps to make the system usable and prepared to perform
following steps.</p>

<h3 id="system-info">System info</h3>

<p>All steps described in this document have been performed on brand new Fedora 35
Server installation:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /etc/fedora-release 

Fedora release 35 (Thirty Five)
</code></pre></div></div>

<p>Kernel version:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ uname -a

Linux hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com 5.16.15-201.fc35.x86_64 #1 SMP PREEMPT Thu Mar 17 05:45:13 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
</code></pre></div></div>

<h3 id="common-packages-to-be-used">Common packages to be used</h3>

<p>First we need to install several packages that are not included in default
Fedora Server system:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dnf install git
# dnf install wget
# dnf install tar
</code></pre></div></div>

<h2 id="postgresql-installation-and-setup">PostgreSQL installation and setup</h2>

<p>Install local PostgreSQL in case you need to run benchmarks and performance
tests against local DB running on bare metal.</p>

<h3 id="package-installation">Package installation</h3>

<p>Install:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dnf install postgresql-server
</code></pre></div></div>

<p>Check installation:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ psql --version

psql (PostgreSQL) 13.4
</code></pre></div></div>

<h3 id="database-setup">Database setup</h3>

<p>Initialize database:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># /usr/bin/postgresql-setup --initdb

 * Initializing database in '/var/lib/pgsql/data'
 * Initialized, logs are in /var/lib/pgsql/initdb_postgresql.log
</code></pre></div></div>

<p>Setup how users and services will be logged into DB:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># vim /var/lib/pgsql/data/pg_hba.conf
</code></pre></div></div>

<p>Change to:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># "local" is for Unix domain socket connections only
# local   all             all                                     peer
local   all             all                                     password
# IPv4 local connections:
host    all             all             127.0.0.1/32            password
# IPv6 local connections:
host    all             all             ::1/128                 password
</code></pre></div></div>

<h3 id="start-db-service">Start DB service</h3>

<p>Start the service:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># systemctl start postgresql

# systemctl status postgresql

● postgresql.service - PostgreSQL database server
     Loaded: loaded (/usr/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)
     Active: active (running) since Tue 2022-03-22 05:51:59 EDT; 2s ago
    Process: 31514 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, status=0/SUCCESS)
   Main PID: 31516 (postmaster)
      Tasks: 8 (limit: 4661)
     Memory: 15.9M
        CPU: 34ms
     CGroup: /system.slice/postgresql.service
             ├─31516 /usr/bin/postmaster -D /var/lib/pgsql/data
             ├─31517 "postgres: logger " "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" ""
             ├─31519 "postgres: checkpointer " "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" ""
             ├─31520 "postgres: background writer " "" "" "" "" "" "" "" "" "" "" "" "" "" ""
             ├─31521 "postgres: walwriter " "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" ""
             ├─31522 "postgres: autovacuum launcher " "" "" "" "" "" "" "" "" "" "" "" ""
             ├─31523 "postgres: stats collector " "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" ""
             └─31524 "postgres: logical replication launcher " "" "" ""
</code></pre></div></div>

<p>Check if the service has been really started and look for any error message or warning:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mar 22 05:51:59 hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com systemd[1]: Starting PostgreSQL database server...
Mar 22 05:51:59 hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com postmaster[31516]: 2022-03-22 05:51:59.877 EDT [31516] LOG:  redirecting log output to log&gt;
Mar 22 05:51:59 hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com postmaster[31516]: 2022-03-22 05:51:59.877 EDT [31516] HINT:  Future log output will appea&gt;
Mar 22 05:51:59 hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com systemd[1]: Started PostgreSQL database server.
</code></pre></div></div>

<h3 id="create-postgresql-account">Create PostgreSQL account</h3>

<p>Change password for user <code class="language-plaintext highlighter-rouge">postgres</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># passwd postgres
Changing password for user postgres.
New password:
Retype new password:
passwd: all authentication tokens updated successfully.
</code></pre></div></div>

<p>Change password in DB</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psql -U postgres
postgres=# ALTER USER postgres PASSWORD 'postgres';
ALTER ROLE
</code></pre></div></div>

<h3 id="alternative-setup-on-recent-fedoras">Alternative setup on recent Fedoras</h3>

<ul>
  <li>Edit <code class="language-plaintext highlighter-rouge">pg_hba.conf</code>
    <ul>
      <li>set the auth mode to <code class="language-plaintext highlighter-rouge">trust</code> instead of the default <code class="language-plaintext highlighter-rouge">md5</code></li>
      <li>it will enable “password-less” login</li>
    </ul>
  </li>
  <li>Restart DB</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># systemctl start postgresql
</code></pre></div></div>

<ul>
  <li>
    <p>Connect to DB with <code class="language-plaintext highlighter-rouge">psql</code> without password</p>
  </li>
  <li>
    <p>Change password for <code class="language-plaintext highlighter-rouge">postgres</code> user</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ALTER USER postgres PASSWORD 'postgres';
</code></pre></div></div>

<ul>
  <li>Edit <code class="language-plaintext highlighter-rouge">pg_hba.conf</code> again
    <ul>
      <li>set the auth mode back to <code class="language-plaintext highlighter-rouge">md5</code> or to <code class="language-plaintext highlighter-rouge">password</code></li>
    </ul>
  </li>
  <li>Restart DB</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># systemctl start postgresql
</code></pre></div></div>

<h2 id="kafka-installation-and-setup">Kafka installation and setup</h2>

<p>Install local Kafka in case you need to run benchmarks and performance
tests against local message broker.</p>

<h3 id="package-installation-1">Package installation</h3>

<p>Install Java package:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dnf install java
</code></pre></div></div>

<p>Check installation:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ java -version
openjdk version "11.0.14.1" 2022-02-08
OpenJDK Runtime Environment 18.9 (build 11.0.14.1+1)
OpenJDK 64-Bit Server VM 18.9 (build 11.0.14.1+1, mixed mode, sharing)
</code></pre></div></div>

<p>Get Kafka package:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wget https://dlcdn.apache.org/kafka/3.1.0/kafka_2.12-3.1.0.tgz

--2022-03-22 10:13:01--  https://dlcdn.apache.org/kafka/3.1.0/kafka_2.12-3.1.0.tgz
Resolving dlcdn.apache.org (dlcdn.apache.org)... 2a04:4e42::644, 151.101.2.132
Connecting to dlcdn.apache.org (dlcdn.apache.org)|2a04:4e42::644|:443... failed: Network is unreachable.
Connecting to dlcdn.apache.org (dlcdn.apache.org)|151.101.2.132|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 88217241 (84M) [application/x-gzip]
Saving to: ‘kafka_2.12-3.1.0.tgz’

kafka_2.12-3.1.0.tg 100%[===================&gt;]  84.13M  93.7MB/s    in 0.9s

2022-03-22 10:13:02 (93.7 MB/s) - ‘kafka_2.12-3.1.0.tgz’ saved [88217241/88217241]
</code></pre></div></div>

<p>Decompress tarball:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar xvfz kafka_2.12-3.1.0.tgz
</code></pre></div></div>

<h3 id="start-zookeeper-and-kafka">Start Zookeeper and Kafka</h3>

<p>Start the Zookeeper first:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd kafka_2.12-3.1.0

$ bin/zookeeper-server-start.sh config/zookeeper.properties

[2022-03-22 10:34:33,179] INFO Reading configuration from: config/zookeeper.properties (org.apache.zookeeper.server.quorum.QuorumPeerConfig)
[2022-03-22 10:34:33,179] INFO Reading configuration from: config/zookeeper.properties (org.apache.zookeeper.server.quorum.QuorumPeerConfig)
[2022-03-22 10:34:33,190] INFO clientPortAddress is 0.0.0.0:2181 (org.apache.zookeeper.server.quorum.QuorumPeerConfig)
</code></pre></div></div>

<p>Then start Kafka broker itself:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd kafka_2.12-3.1.0

$ bin/kafka-server-start.sh config/server.properties

[2022-03-22 10:36:47,534] INFO Registered kafka:type=kafka.Log4jController MBean (kafka.utils.Log4jControllerRegistration$)
[2022-03-22 10:36:48,109] INFO Setting -D jdk.tls.rejectClientInitiatedRenegotiation=true to disable client-initiated TLS renegotiation (org.apache.zookeeper.common.X509Util)
[2022-03-22 10:36:50,467] INFO [BrokerToControllerChannelManager broker=0 name=alterIsr]: Recorded new controller, from now on will use broker hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com:9092 (id: 0 rack: null) (kafka.server.BrokerToControllerRequestThread)
[2022-03-22 10:36:50,511] INFO [BrokerToControllerChannelManager broker=0 name=forwarding]: Recorded new controller, from now on will use broker hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com:9092 (id: 0 rack: null) (kafka.server.BrokerToControllerRequestThread)
</code></pre></div></div>

<h2 id="kafkacat-installation-and-setup">Kafkacat installation and setup</h2>

<p>Install Kafkacat (now named Kcat) in order to be able to publish messages during benchmarking and testing.</p>

<h3 id="installation">Installation</h3>

<p>Install all required packages first:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dnf install gcc-g++ cmake
# dnf install cyrus-sasl-devel zlib-devel libcurl-devel krb5-devel
</code></pre></div></div>

<p>Retrieve Kafkacat/Kcat sources:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone https://github.com/edenhill/kafkacat.git
$ cd kafkacat
</code></pre></div></div>

<h3 id="build">Build</h3>

<p>Try to build Kafkacat/Kcat:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./bootstrap.sh
</code></pre></div></div>

<p>Please note that sometimes it is needed to fix some “side” errors like
rebuilding <code class="language-plaintext highlighter-rouge">libyajl</code> by hands (it is located in <code class="language-plaintext highlighter-rouge">tmp-bootstrap/libyajl</code>
subdirectory).</p>

<p>Finally, check if binary has been produced:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./kcat -V

kcat - Apache Kafka producer and consumer tool
https://github.com/edenhill/kcat
Copyright (c) 2014-2021, Magnus Edenhill
Version 1.7.1-2-g338ae3 (JSON, Avro, Transactions, IncrementalAssign, JSONVerbatim, librdkafka 1.8.2 builtin.features=gzip,snappy,ssl,sasl,regex,lz4,sasl_gssapi,sasl_plain,sasl_scram,plugins,zstd,sasl_oauthbearer)
</code></pre></div></div>

<h3 id="check-connection-to-kafka">Check connection to Kafka</h3>

<p>Now check if Kafkacat/kcat works as expected. We can use local broker that’s been started already:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./kcat -L -b localhost:9092

Metadata for all topics (from broker -1: localhost:9092/bootstrap):
 1 brokers:
  broker 0 at hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com:9092 (controller)
 0 topics:
</code></pre></div></div>

<h2 id="insights-results-aggregator-installation-and-setup">Insights Results Aggregator installation and setup</h2>

<p>Now Insights Results Aggregator can be installed and setup.</p>

<h3 id="dependend-packages-installation">Dependend packages installation</h3>

<p>Install Go:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dnf install go
</code></pre></div></div>

<p>Check if Go was installed correctly:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ go version

go version go1.16.15 linux/amd64
</code></pre></div></div>

<h3 id="insights-results-aggregator-setup">Insights Results Aggregator setup</h3>

<p>Clone the repository:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone https://github.com/RedHatInsights/insights-results-aggregator.git

Cloning into 'insights-results-aggregator'...
remote: Enumerating objects: 10761, done.
remote: Counting objects: 100% (786/786), done.
remote: Compressing objects: 100% (451/451), done.
remote: Total 10761 (delta 469), reused 527 (delta 326), pack-reused 9975
Receiving objects: 100% (10761/10761), 11.32 MiB | 21.07 MiB/s, done.
Resolving deltas: 100% (7198/7198), done.
</code></pre></div></div>

<p>Build the service:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd insights-results-aggregator
$ make
</code></pre></div></div>

<p>Check if the service has been built correctly:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./insights-results-aggregator --help

Clowder is not enabled, skipping init...
Clowder is disabled

Command '--help' not found

Aggregator service for insights results

Usage:

    ./insights-results-aggregator [command]

The commands are:

    &lt;EMPTY&gt;             starts aggregator
    start-service       starts aggregator
    help                prints help
    print-help          prints help
    print-config        prints current configuration set by files &amp; env variables
    print-env           prints env variables
    print-version-info  prints version info
    migration           prints information about migrations (current, latest)
    migration &lt;version&gt; migrates database to the specified version
</code></pre></div></div>

<h3 id="aggregator-database-setup">Aggregator database setup</h3>

<p>First, empty database needs to be prepared in PostgreSQL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># psql -U postgres

Password for user postgres:
psql (13.4)
Type "help" for help.



postgres=# create database aggregator;
CREATE DATABASE
postgres=# \q
</code></pre></div></div>

<p>Check if migration have not happened (yet):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./insights-results-aggregator migration

Clowder is not enabled, skipping init...
Clowder is disabled
{"level":"info","time":"2022-03-22T07:21:57-04:00","message":"Making connection to data storage, driver=postgresWithHooks datasource=postgresql://postgres:postgres@localhost:5432/aggregator?sslmode=disable"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `CREATE TABLE IF NOT EXISTS migration_info (version INTEGER NOT NULL);` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `CREATE TABLE IF NOT EXISTS migration_info (version INTEGER NOT NULL);` with params `[]` took 2.017535ms\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `INSERT INTO migration_info (version) SELECT 0 WHERE NOT EXISTS (SELECT version FROM migration_info);` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `INSERT INTO migration_info (version) SELECT 0 WHERE NOT EXISTS (SELECT version FROM migration_info);` with params `[]` took 696.923µs\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]` took 528.857µs\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]` took 342.38µs\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `SELECT version FROM migration_info;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:21:57-04:00","message":"query `SELECT version FROM migration_info;` with params `[]` took 133.918µs\n"}
{"level":"info","time":"2022-03-22T07:21:57-04:00","message":"Current DB version: 0"}
{"level":"info","time":"2022-03-22T07:21:57-04:00","message":"Maximum available version: 22"}
{"level":"info","time":"2022-03-22T07:21:57-04:00","message":"Closing connection to data storage"}
</code></pre></div></div>

<p>Migrate to latest schema:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./insights-results-aggregator migration latest

...
...
...
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:18-04:00","message":"query `UPDATE migration_info SET version=$1;` with params `[22]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:18-04:00","message":"query `UPDATE migration_info SET version=$1;` with params `[22]` took 362.156µs\n"}
{"level":"info","time":"2022-03-22T07:22:18-04:00","message":"Database version is now 22"}
{"level":"info","time":"2022-03-22T07:22:18-04:00","message":"Closing connection to data storage"}
</code></pre></div></div>

<p>Check the migration again:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./insights-results-aggregator migration

Clowder is not enabled, skipping init...
Clowder is disabled
{"level":"info","time":"2022-03-22T07:22:32-04:00","message":"Making connection to data storage, driver=postgresWithHooks datasource=postgresql://postgres:postgres@localhost:5432/aggregator?sslmode=disable"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `CREATE TABLE IF NOT EXISTS migration_info (version INTEGER NOT NULL);` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `CREATE TABLE IF NOT EXISTS migration_info (version INTEGER NOT NULL);` with params `[]` took 337.499µs\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `INSERT INTO migration_info (version) SELECT 0 WHERE NOT EXISTS (SELECT version FROM migration_info);` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `INSERT INTO migration_info (version) SELECT 0 WHERE NOT EXISTS (SELECT version FROM migration_info);` with params `[]` took 478.954µs\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]` took 276.456µs\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]` took 148.287µs\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `SELECT version FROM migration_info;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-22T07:22:32-04:00","message":"query `SELECT version FROM migration_info;` with params `[]` took 135.369µs\n"}
{"level":"info","time":"2022-03-22T07:22:32-04:00","message":"Current DB version: 22"}
{"level":"info","time":"2022-03-22T07:22:32-04:00","message":"Maximum available version: 22"}
{"level":"info","time":"2022-03-22T07:22:32-04:00","message":"Closing connection to data storage"}
</code></pre></div></div>

<p>Check the DB content (just for sure):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ psql -U postgres -h localhost

Password for user postgres:
psql (13.4)
Type "help" for help.



postgres=# \c aggregator
You are now connected to database "aggregator" as user "postgres".
aggregator=# \dt
                       List of relations
 Schema |                Name                | Type  |  Owner
--------+------------------------------------+-------+----------
 public | advisor_ratings                    | table | postgres
 public | cluster_rule_toggle                | table | postgres
 public | cluster_rule_user_feedback         | table | postgres
 public | cluster_user_rule_disable_feedback | table | postgres
 public | consumer_error                     | table | postgres
 public | migration_info                     | table | postgres
 public | recommendation                     | table | postgres
 public | report                             | table | postgres
 public | rule_disable                       | table | postgres
 public | rule_hit                           | table | postgres
(10 rows)
</code></pre></div></div>

<h3 id="run-db-writer">Run DB writer</h3>

<p>Last step is to run the DB writer:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./insights-results-aggregator 

Clowder is not enabled, skipping init...
Clowder is disabled
{"level":"info","type":"init","time":"2022-03-24T07:59:27-04:00","message":"Version: 0.5"}
{"level":"info","type":"init","time":"2022-03-24T07:59:27-04:00","message":"Build time: Tue Mar 22 05:29:03 AM EDT 2022"}
{"level":"info","type":"init","time":"2022-03-24T07:59:27-04:00","message":"Branch: master"}
{"level":"info","type":"init","time":"2022-03-24T07:59:27-04:00","message":"Commit: 35270ba93d9a9b91bfbe74b5e74764e8d57b5294"}
{"level":"info","type":"init","time":"2022-03-24T07:59:27-04:00","message":"Utils version:v1.23.3"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"Making connection to data storage, driver=postgresWithHooks datasource=postgresql://postgres:postgres@localhost:5432/aggregator?sslmode=disable"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]` took 1.484884ms\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT version FROM migration_info;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT version FROM migration_info;` with params `[]` took 215.947µs\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT cluster, last_checked_at FROM report;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT cluster, last_checked_at FROM report;` with params `[]` took 789.466µs\n"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"PrintRuleToggles start"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `\n\tSELECT\n\t\trule_id,\n\t\tcount(*)\n\tFROM\n\t\tcluster_rule_toggle\n\tGROUP BY\n\t\trule_id\n\t` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `\n\tSELECT\n\t\trule_id,\n\t\tcount(*)\n\tFROM\n\t\tcluster_rule_toggle\n\tGROUP BY\n\t\trule_id\n\t` with params `[]` took 1.13213ms\n"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"PrintRuleDisableFeedbacks start"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `\n\tSELECT\n\t\trule_id,\n\t\tcount(*)\n\tFROM\n\t\tcluster_user_rule_disable_feedback\n\tGROUP BY\n\t\trule_id\n\t` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `\n\tSELECT\n\t\trule_id,\n\t\tcount(*)\n\tFROM\n\t\tcluster_user_rule_disable_feedback\n\tGROUP BY\n\t\trule_id\n\t` with params `[]` took 557.768µs\n"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"Closing connection to data storage"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"Making connection to data storage, driver=postgresWithHooks datasource=postgresql://postgres:postgres@localhost:5432/aggregator?sslmode=disable"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"Making connection to data storage, driver=postgresWithHooks datasource=postgresql://postgres:postgres@localhost:5432/aggregator?sslmode=disable"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Initializing new client"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"ClientID is the default of 'sarama', you should consider setting it to something application-specific."}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"ClientID is the default of 'sarama', you should consider setting it to something application-specific."}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/metadata fetching metadata for all topics from broker localhost:9092\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]`\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Connected to broker at localhost:9092 (unregistered)\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT COUNT(*) FROM migration_info;` with params `[]` took 3.053161ms\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT version FROM migration_info;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT version FROM migration_info;` with params `[]` took 177.899µs\n"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"Starting HTTP server at ':8080'"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"Initializing HTTP server at ':8080'"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/brokers registered new broker #0 at hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com:9092"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Successfully initialized new client"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Initializing new client"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"ClientID is the default of 'sarama', you should consider setting it to something application-specific."}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"ClientID is the default of 'sarama', you should consider setting it to something application-specific."}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/metadata fetching metadata for all topics from broker localhost:9092\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Connected to broker at localhost:9092 (unregistered)\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/brokers registered new broker #0 at hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com:9092"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Successfully initialized new client"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Initializing new client"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"ClientID is the default of 'sarama', you should consider setting it to something application-specific."}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"ClientID is the default of 'sarama', you should consider setting it to something application-specific."}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/metadata fetching metadata for all topics from broker localhost:9092\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Connected to broker at localhost:9092 (unregistered)\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/brokers registered new broker #0 at hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com:9092"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Successfully initialized new client"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"waiting for consumer to become ready"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/metadata fetching metadata for [ccx.ocp.results] from broker localhost:9092\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/coordinator requesting coordinator for consumergroup aggregator from localhost:9092\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/coordinator coordinator for consumergroup aggregator is #0 (hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com:9092)\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"ClientID is the default of 'sarama', you should consider setting it to something application-specific."}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"Connected to broker at hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com:9092 (registered as #0)\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/coordinator requesting coordinator for consumergroup aggregator from localhost:9092\n"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"client/coordinator coordinator for consumergroup aggregator is #0 (hpe-dl380pgen8-02-vm-15.hpe2.lab.eng.bos.redhat.com:9092)\n"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"new session has been setup"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"finished waiting for consumer to become ready"}
{"level":"info","time":"2022-03-24T07:59:27-04:00","message":"started serving consumer"}
{"level":"info","package":"sarama","time":"2022-03-24T07:59:27-04:00","message":"consumer/broker/0 added subscription to ccx.ocp.results/0\n"}
{"level":"info","offset":18,"time":"2022-03-24T07:59:27-04:00","message":"starting messages loop"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT COALESCE(MAX(kafka_offset), 0) FROM report;` with params `[]`\n"}
{"level":"debug","type":"SQL","time":"2022-03-24T07:59:27-04:00","message":"query `SELECT COALESCE(MAX(kafka_offset), 0) FROM report;` with params `[]` took 1.635786ms\n"}
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>Now all services should be configured correctly and it is possible to run
benchmarks and performance tests against any of such service (especially by
producing data to Kafka topic consumed by Insights Aggregator DB Writer).</p>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/RedHatInsights/insights-results-aggregator/edit/gh-pages/local_setup_bare_metal.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
